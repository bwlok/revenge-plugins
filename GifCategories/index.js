(function(m,R,w,_,e,x,h,I,J,g,O,T){"use strict";const B="https://cgifs.bwlok.dev",Z="1433591269807882321",q=B+"/auth/discord/callback";function Q(r,t){return e.FluxDispatcher.subscribe(r,t),function(){return void e.FluxDispatcher.unsubscribe(r,t)}}const G=R.findByStoreName("UserStore");I.storage.gif_auth||(I.storage.gif_auth={tokens:{}});const $=new Set,p={token:null,tokens:I.storage.gif_auth.tokens??{},init(){const r=G?.getCurrentUser?.();r?.id&&(p.tokens=I.storage.gif_auth.tokens??{},p.token=p.tokens[r.id]??null,M())},setToken(r){const t=G?.getCurrentUser?.();t?.id&&(p.tokens={...p.tokens,[t.id]:r},I.storage.gif_auth.tokens=p.tokens,p.token=r,M())},isAuthorized(){return!!p.token}};function M(){for(const r of $)r()}function L(r){return $.add(r),function(){return $.delete(r)}}function ee(){const[,r]=e.React.useState(0);return e.React.useEffect(function(){return L(function(){return r(function(t){return t+1})})},[]),p}const v=ee;v.getState=function(){return p},v.subscribe=L,p.init(),Q("CONNECTION_OPEN",function(){return p.init()});const{pushModal:te,popModal:V}=R.findByProps("pushModal"),re=R.findByName("OAuth2AuthorizeModal");function ae(){return te({key:"oauth2-authorize",modal:{key:"oauth2-authorize",modal:re,animation:"slide-up",shouldPersistUnderModals:!1,props:{clientId:Z,redirectUri:q,scopes:["identify"],responseType:"code",permissions:0n,cancelCompletesFlow:!1,callback:async function({location:r}){const t=new URL(r);t.searchParams.append("client","revenge");const n=await fetch(t);if(n?.ok){const i=await n.text();v.getState().setToken(i)}else V("oauth2-authorize")},dismissOAuthModal:function(){return V("oauth2-authorize")}},closable:!0}})}const{ScrollView:ne,View:H,Text:N,ActivityIndicator:ie,TouchableOpacity:oe}=e.ReactNative,{FormRow:A,FormArrow:X,FormDivider:j,FormInput:le,FormCTAButton:we}=x.Forms,C=e.stylesheet.createThemedStyleSheet({versionText:{fontSize:15,color:g.semanticColors.TEXT_NORMAL,textAlign:"center",fontWeight:"600",lineHeight:22},titleText:{fontSize:14,fontWeight:"600",color:g.semanticColors.TEXT_MUTED},authText:{fontSize:15,lineHeight:20,fontWeight:"600",padding:15,color:g.semanticColors.TEXT_BRAND},titleContainer:{marginBottom:8,marginHorizontal:0,marginTop:8,gap:4,flexDirection:"row",alignItems:"center",justifyContent:"space-between"},titleLeft:{flexDirection:"row",alignItems:"center",gap:4},addButton:{backgroundColor:g.semanticColors.BUTTON_POSITIVE_BACKGROUND,borderRadius:12,width:24,height:24,justifyContent:"center",alignItems:"center"},addButtonText:{color:"#FFFFFF",fontSize:18,fontWeight:"bold",lineHeight:20},deleteButton:{backgroundColor:g.semanticColors.BUTTON_DANGER_BACKGROUND,borderRadius:8,paddingHorizontal:12,paddingVertical:6},deleteButtonText:{color:"#FFFFFF",fontSize:12,fontWeight:"600"},loadingContainer:{padding:20,alignItems:"center"},loadingText:{marginTop:8,fontSize:14,color:g.semanticColors.TEXT_MUTED},emptyText:{padding:20,textAlign:"center",fontSize:14,color:g.semanticColors.TEXT_MUTED}});function z({title:r,icon:t,children:n,padding:i=!1,action:l}){const s=e.stylesheet.createThemedStyleSheet({main:{backgroundColor:g.semanticColors.CARD_PRIMARY_BG,borderColor:g.semanticColors.BORDER_FAINT,borderWidth:1,borderRadius:16,overflow:"hidden",flex:1},icon:{width:16,height:16,marginTop:1.5,tintColor:g.semanticColors.TEXT_MUTED}});return e.React.createElement(e.ReactNative.View,{style:{marginHorizontal:16,marginTop:16}},r&&e.React.createElement(e.ReactNative.View,{style:C.titleContainer},e.React.createElement(e.ReactNative.View,{style:C.titleLeft},t&&e.React.createElement(e.ReactNative.Image,{style:s.icon,source:t,resizeMode:"cover"}),e.React.createElement(e.ReactNative.Text,{style:C.titleText},r.toUpperCase())),l),e.React.createElement(e.ReactNative.View,{style:s.main},i?e.React.createElement(e.ReactNative.View,{style:{paddingHorizontal:16,paddingVertical:16}},n):n))}function ce({refreshKey:r}){const[t,n]=e.React.useState([]),[i,l]=e.React.useState(!0),{token:s,isAuthorized:f}=v();e.React.useEffect(function(){y()},[r,s,f]);async function y(){if(!f()){l(!1);return}try{const a=await fetch(`${B}/user/data`,{headers:{Authorization:`Bearer ${s}`}});if(a.ok){const c=await a.json();n(c)}}catch(a){console.error("Error fetching categories:",a)}finally{l(!1)}}async function d(a){O.showConfirmationAlert({title:"Delete Category",content:`Are you sure you want to delete "${a}" and all its GIFs?`,confirmText:"Delete",confirmColor:"red",onConfirm:async function(){try{(await fetch(`${B}/user/category/${encodeURIComponent(a)}`,{method:"DELETE",headers:{Authorization:`Bearer ${s}`}})).ok?(T.showToast("Category deleted",h.getAssetIDByName("TrashIcon")),await y()):T.showToast("Failed to delete category",h.getAssetIDByName("Small"))}catch(c){console.error("Error deleting category:",c),T.showToast("Error deleting category",h.getAssetIDByName("Small"))}},cancelText:"Cancel"})}return f()?i?e.React.createElement(H,{style:C.loadingContainer},e.React.createElement(ie,{size:"small"}),e.React.createElement(N,{style:C.loadingText},"Loading categories...")):t.length===0?e.React.createElement(N,{style:C.emptyText},"No categories yet."):e.React.createElement(e.React.Fragment,null,t.map(function(a,c){return e.React.createElement(e.React.Fragment,{key:a.name},e.React.createElement(A,{label:a.name,subLabel:`${a.gifs?.length||0} GIFs`,trailing:e.React.createElement(oe,{style:C.deleteButton,onPress:function(){return d(a.name)}},e.React.createElement(N,{style:C.deleteButtonText},"Delete"))}),c<t.length-1&&e.React.createElement(j,null))})):e.React.createElement(N,{style:C.emptyText},"Please authorize to manage categories")}function se(){J.useProxy(I.storage);const[r,t]=e.React.useState(0),{isAuthorized:n,token:i}=v(),[l,s]=e.React.useState(""),[f,y]=e.React.useState(!1),[d,a]=e.React.useState("");async function c(){if(!l.trim()){T.showToast("Missing Name",h.getAssetIDByName("Small"));return}y(!0),a("");try{const o=await fetch(`${B}/user/category`,{method:"POST",headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"},body:JSON.stringify({name:l.trim()})});if(o.ok)T.showToast("Category created",h.getAssetIDByName("Check")),s(""),t(function(u){return u+1});else{const u=await o.json();a(u.error||"Failed to create category")}}catch(o){console.error("Error creating category:",o),a("Error creating category")}finally{y(!1)}}return e.React.createElement(ne,{style:{flex:1,backgroundColor:g.semanticColors.BACKGROUND_PRIMARY}},!n()&&e.React.createElement(z,null,e.React.createElement(H,null,e.React.createElement(N,{style:C.authText},"You need to authorize to create categories")),e.React.createElement(A,{label:"Authorize",leading:e.React.createElement(A.Icon,{source:h.getAssetIDByName("UserIcon")}),trailing:X,onPress:ae})),n()&&e.React.createElement(z,{title:"Categories"},e.React.createElement(ce,{refreshKey:r})),n()&&e.React.createElement(z,{title:"Create Categories"},e.React.createElement(le,{placeholder:"Enter category name",value:l,onChange:function(o){s(o),d&&a("")},returnKeyType:"done",onSubmitEditing:c,style:{marginTop:0,marginBottom:8}}),d?e.React.createElement(N,{style:{color:g.semanticColors.TEXT_DANGER,fontSize:14}},d):null,e.React.createElement(A,{label:"Create Category",trailing:X,onPress:c})),e.React.createElement(z,{title:"More Options"},n()&&e.React.createElement(A,{color:"danger",label:"Logout",leading:e.React.createElement(A.Icon,{source:h.getAssetIDByName("DoorExitIcon")}),onPress:function(){return O.showConfirmationAlert({title:"Logout",content:"Are you sure you want to logout?",confirmText:"Logout",confirmColor:"red",cancelText:"Cancel",onConfirm:function(){I.storage.token=void 0,v.getState().setToken(null)}})}}),n()&&e.React.createElement(j,null),e.React.createElement(A,{label:"Source",leading:e.React.createElement(A.Icon,{source:h.getAssetIDByName("img_account_sync_github_white")}),trailing:e.React.createElement(A.Icon,{source:h.getAssetIDByName("ic_launch")}),onPress:function(){return e.ReactNative.Linking.openURL("https://github.com/bwlok/revenge-plugins/tree/master/plugins/GifCategories")}})),e.React.createElement(e.ReactNative.View,{style:{height:16}}),e.React.createElement(e.ReactNative.Text,{style:C.versionText},"Version 0.1.1"),e.React.createElement(e.ReactNative.View,{style:{height:32}}))}const{ScrollView:ue,View:S,Text:k,ActivityIndicator:W}=e.ReactNative,{FormRow:ge,FormArrow:fe}=x.Forms,E=e.stylesheet.createThemedStyleSheet({centerContainer:{flex:1,justifyContent:"center",alignItems:"center",padding:20,backgroundColor:g.semanticColors.BACKGROUND_PRIMARY},errorText:{fontSize:16,fontWeight:"bold",marginBottom:8,textAlign:"center",color:g.semanticColors.TEXT_NORMAL},hintText:{fontSize:14,color:g.semanticColors.TEXT_MUTED,textAlign:"center"},loadingText:{marginTop:12,fontSize:14,color:g.semanticColors.TEXT_MUTED},savingOverlay:{position:"absolute",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0)",justifyContent:"center",alignItems:"center"},savingText:{marginTop:12,fontSize:16,color:"#fff",fontWeight:"bold"},titleContainer:{marginBottom:8,marginHorizontal:16,marginTop:16,gap:4,flexDirection:"row",alignItems:"center"},titleText:{fontSize:14,fontWeight:"600",color:g.semanticColors.TEXT_MUTED},icon:{width:16,height:16,marginTop:1.5,tintColor:g.semanticColors.TEXT_MUTED}});function de({title:r,icon:t,children:n}){const i=e.stylesheet.createThemedStyleSheet({main:{backgroundColor:g.semanticColors.CARD_PRIMARY_BG,borderColor:g.semanticColors.BORDER_FAINT,borderWidth:1,borderRadius:16,overflow:"hidden",flex:1}});return e.React.createElement(S,{style:{marginHorizontal:16,marginTop:16}},r&&e.React.createElement(S,{style:E.titleContainer},t&&e.React.createElement(e.ReactNative.Image,{style:E.icon,source:t,resizeMode:"cover"}),e.React.createElement(k,{style:E.titleText},r.toUpperCase())),e.React.createElement(S,{style:i.main},n))}function he({gifData:r}){const[t,n]=e.React.useState([]),[i,l]=e.React.useState(!0),[s,f]=e.React.useState(!1),{token:y,isAuthorized:d}=v.getState();e.React.useEffect(function(){a()},[]);async function a(){if(!d()){T.showToast("Please login first",h.getAssetIDByName("Small")),l(!1);return}try{const o=await fetch(`${B}/user/data`,{headers:{Authorization:`Bearer ${y}`}});if(o.ok){const u=await o.json();n(u)}else T.showToast("Failed to load categories",h.getAssetIDByName("Small"))}catch(o){console.error("Error fetching categories:",o),T.showToast("Error loading categories",h.getAssetIDByName("Small"))}finally{l(!1)}}async function c(o){f(!0);try{(await fetch(`${B}/user/gif`,{method:"POST",headers:{Authorization:`Bearer ${y}`,"Content-Type":"application/json"},body:JSON.stringify({categoryName:o,gif:r})})).ok?(T.showToast(`Saved to ${o}`,h.getAssetIDByName("Check")),await a()):T.showToast("Failed to save GIF",h.getAssetIDByName("Small"))}catch(u){console.error("Error saving gif:",u),T.showToast("Error saving GIF",h.getAssetIDByName("Small"))}finally{f(!1)}}return d()?i?e.React.createElement(S,{style:E.centerContainer},e.React.createElement(W,{size:"large"}),e.React.createElement(k,{style:E.loadingText},"Loading categories...")):t.length===0?e.React.createElement(S,{style:E.centerContainer},e.React.createElement(k,{style:E.errorText},"No categories yet"),e.React.createElement(k,{style:E.hintText},"Create your first category by going into the Plugin settings")):e.React.createElement(ue,{style:{flex:1,backgroundColor:g.semanticColors.BACKGROUND_PRIMARY}},e.React.createElement(de,null,t.map(function(o,u){return e.React.createElement(e.React.Fragment,{key:o.name},e.React.createElement(ge,{key:o.name,label:o.name,subLabel:`${o.gifs?.length||0} GIFs`,trailing:fe,onPress:function(){return c(o.name)},disabled:s}),u<t.length-1&&e.React.createElement(x.Forms.FormDivider,null))})),e.React.createElement(S,{style:{height:32}}),s&&e.React.createElement(S,{style:E.savingOverlay},e.React.createElement(W,{size:"large",color:"#fff"}),e.React.createElement(k,{style:E.savingText},"Saving..."))):e.React.createElement(S,{style:E.centerContainer},e.React.createElement(k,{style:E.errorText},"Please login to save GIFs"))}const ye=R.findByProps("getTrendingCategories"),Re=R.findByTypeName("GIFPickerCategoriesPage"),P=R.findByProps("openLazy","hideActionSheet"),{FormRow:pe,FormIcon:K}=x.Forms,Ee=R.findByName("Navigator")??R.findByProps("Navigator")?.Navigator,U=R.findByProps("push","pushLazy","pop"),Te=R.findByProps("getRenderCloseButton")?.getRenderCloseButton??R.findByProps("getHeaderCloseButton")?.getHeaderCloseButton;let F=null,b=[],D=[];function Ce(r){const t=r.embeds?.[0];if(!t)return null;const n=t.type==="gifv",i=t.type==="image"&&t.image?.srcIsAnimated,l=t.type==="image"&&t.image?.contentType==="image/gif",s=t.url?.includes(".gif")||t.image?.url?.includes(".gif");if(!n&&!i&&!l&&!s)return null;const f=t.url;let y,d,a,c;if((i||l||s)&&t.image)return y=t.image.width||498,d=t.image.height||498,a=t.image.url||f,c=1,{format:c,src:a,url:f,width:y,height:d,provider:"discord"};if(n){const o=t.provider?.name?.toLowerCase();switch(y=t.video?.width||t.thumbnail?.width||498,d=t.video?.height||t.thumbnail?.height||498,o){case"tenor":a=f+".gif",c=2;break;case"giphy":const u=f.match(/giphy\.com\/gifs\/(?:.*-)?([a-zA-Z0-9]+)$/);u?a=`https://media.giphy.com/media/${u[1]}/giphy.gif`:a=f,c=2;break;case"imgur":t.video?.url?a=t.video.url.replace(/\.(mp4|gifv)$/,".gif"):a=f.replace(/\.(mp4|gifv)$/,".gif"),c=2;break;default:a=t.video?.url||t.thumbnail?.url||f,c=2;break}return{format:c,src:a,url:f,width:y,height:d,provider:o||"unknown"}}return null}async function Y(){const{token:r,isAuthorized:t}=v.getState();if(!t()){b=[];return}try{const n=await fetch(`${B}/user/data`,{headers:{Authorization:`Bearer ${r}`}});n.ok?b=await n.json():(console.error("[SaveGif] Failed to fetch categories:",n.status),b=[])}catch(n){console.error("[SaveGif] Error fetching categories:",n),b=[]}}var ve={onLoad:function(){Y(),D.push(w.after("getTrendingCategories",ye,function(r,t){Y();const{isAuthorized:n}=v.getState();if(!n()||b.length===0)return t;b.forEach(function(i){const l=t.some(function(s){return s.type===i.type&&s.name===i.name&&s.format===i.format});t[0]&&!l&&t.splice(1,0,{type:i.type,name:i.name,src:i.src,format:i.format})})})),D.push(w.after("type",Re,function(r,t){const n=_.findInReactTree(t,function(i){return i?.props});w.after("renderItem",n.props,function(i,l){l&&l.props&&l.props.children&&Array.isArray(l.props.children)&&l.props.children.forEach(function(s){s.props.onSelectCategory&&w.instead("onSelectCategory",s.props,function(f,y){const[d,a]=f;if(d==="BetterCategory"){const c=b.find(function(o){return o.name===a});if(c)return F=c,y("Favorites",a)}return F=null,y(...f)})})})})),D.push(w.instead("useSortedFavoriteGIFs",R.findByProps("useFavoriteGIFs"),function(r,t){const n=t(...r);if(F){const i=F.gifs;return F=null,i}return n})),D.push(w.before("openLazy",P,function([r,t,n]){const i=n?.message;if(t!=="MessageLongPressActionSheet"||!i)return;const l=Ce(i);l&&r.then(function(s){const f=w.after("default",s,function(y,d){e.React.useEffect(function(){return function(){f()}},[]);const a=function(){return e.React.createElement(Ee,{initialRouteName:"SaveGif",goBackOnBackPress:!0,screens:{SaveGif:{title:"Select a Category",headerLeft:Te?.(function(){return U.pop()}),render:function(){return e.React.createElement(he,{gifData:l})}}}})},c=_.findInReactTree(d,function(u){return Array.isArray(u)&&u[0]?.type?.name==="ActionSheetRowGroup"}),o=_.findInReactTree(d,function(u){return u?.[0]?.type?.name==="ButtonRow"});if(o)o.push(e.React.createElement(pe,{label:"Save GIF to Category",leading:e.React.createElement(K,{style:{opacity:1},source:h.getAssetIDByName("gif")}),onPress:function(){P.hideActionSheet(),U.push(a)}}));else if(c&&c[1]){const u=c[0],Ae=u.props.children[0].type,Se=e.React.createElement(Ae,{label:"Save GIF to Category",icon:{$$typeof:u.props.children[0].props.icon.$$typeof,type:u.props.children[0].props.icon.type,key:null,ref:null,props:{IconComponent:function(){return e.React.createElement(K,{style:{opacity:1},source:h.getAssetIDByName("gif")})}}},onPress:function(){P.hideActionSheet(),U.push(a)},key:"save-gif"});u.props.children.push(Se)}else console.log("[SaveGif] Error: Could not find ActionSheet")})})}))},onUnload:function(){for(const r of D)r()},settings:se};return m.default=ve,Object.defineProperty(m,"__esModule",{value:!0}),m})({},vendetta.metro,vendetta.patcher,vendetta.utils,vendetta.metro.common,vendetta.ui.components,vendetta.ui.assets,vendetta.plugin,vendetta.storage,vendetta.ui,vendetta.ui.alerts,vendetta.ui.toasts);
