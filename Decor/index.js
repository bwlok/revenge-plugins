(function(k,i,t,F,b,z,u,g,y,fe,I){"use strict";const he="https://decor.fieryflames.dev",R=he+"/api",ye=R+"/authorize",pe="https://decorcdn.fieryflames.dev",ge="1096966363416899624",A="100101099111114",H="11497119";function C(e,n){return t.FluxDispatcher.subscribe(e,n),function(){return void t.FluxDispatcher.unsubscribe(e,n)}}const G=i.findByStoreName("UserStore");b.storage.decor_auth||(b.storage.decor_auth={tokens:{}});const x=new Set,h={token:null,tokens:b.storage.decor_auth.tokens??{},init(){const e=G?.getCurrentUser?.();e?.id&&(h.tokens=b.storage.decor_auth.tokens??{},h.token=h.tokens[e.id]??null,j())},setToken(e){const n=G?.getCurrentUser?.();n?.id&&(h.tokens={...h.tokens,[n.id]:e},b.storage.decor_auth.tokens=h.tokens,h.token=e,j())},isAuthorized(){return!!h.token}};function j(){for(const e of x)e()}function V(e){return x.add(e),function(){return x.delete(e)}}function Re(){const[,e]=t.React.useState(0);return t.React.useEffect(function(){return V(function(){return e(function(n){return n+1})})},[]),h}const S=Re;S.getState=function(){return h},S.subscribe=V,h.init();const Se=C("CONNECTION_OPEN",function(){return h.init()}),{pushModal:De,popModal:Q}=i.findByProps("pushModal"),Ee=i.findByName("OAuth2AuthorizeModal");function ve(){return De({key:"oauth2-authorize",modal:{key:"oauth2-authorize",modal:Ee,animation:"slide-up",shouldPersistUnderModals:!1,props:{clientId:ge,redirectUri:ye,scopes:["identify"],responseType:"code",permissions:0n,cancelCompletesFlow:!1,callback:async function({location:e}){const n=new URL(e);n.searchParams.append("client","vendetta");const a=await fetch(n);if(a?.ok){const r=await a.text();S.getState().setToken(r)}else Q("oauth2-authorize")},dismissOAuthModal:function(){return Q("oauth2-authorize")}},closable:!0}})}const Ne=t.ReactNative.NativeModules.DCDFileManager??t.ReactNative.NativeModules.RTNFileManager;async function be(e){return e.startsWith("file://")&&(e=e.slice(7)),Ne.readFile(e,"base64")}const{View:W}=y.General,Ae=i.findByName("HeaderAvatar"),Ce=i.findByStoreName("UserStore"),K=t.stylesheet.createThemedStyleSheet({headerAvatarContainer:{display:"flex",justifyContent:"center",alignItems:"center",backgroundColor:g.semanticColors.BACKGROUND_FLOATING,width:208,height:208,borderRadius:4},container:{flexDirection:"row",width:"100%",justifyContent:"center",alignItems:"center",paddingHorizontal:16,paddingTop:16}});function Y({pendingAvatarDecoration:e}){return React.createElement(W,{style:K.container},React.createElement(W,{style:K.headerAvatarContainer},React.createElement(Ae,{user:Ce.getCurrentUser(),pendingAvatarDecoration:e,size:"editAvatarDecoration",decorationStyle:{margin:-12}})))}async function T(e,n){const a=await fetch(e,{...n,headers:{...n?.headers,Authorization:`Bearer ${S.getState().token}`}});if(a.ok)return a;throw new Error(await a.text())}const we=async function(e=void 0){if(e&&e.length===0)return{};const n=new URL(R+"/users");return e&&e.length!==0&&n.searchParams.set("ids",JSON.stringify(e)),await fetch(n).then(function(a){return a.json()})},Ie=async function(e="@me"){return T(R+`/users/${e}/decorations`).then(function(n){return n.json()})},Te=async function(e="@me"){return T(R+`/users/${e}/decoration`).then(function(n){return n.json()})},X=async function(e,n="@me"){const a=new FormData;return e&&Object.hasOwn(e,"hash")?(e=e,a.append("hash",e.hash)):e?e&&Object.hasOwn(e,"uri")&&(e=e,a.append("image",{uri:e.uri,type:e.fileType,name:e.fileName}),a.append("alt",e.alt)):a.append("hash",null),T(R+`/users/${n}/decoration`,{method:"PUT",body:a}).then(function(r){return e&&Object.hasOwn(e,"uri")?r.json():r.text()})},Pe=async function(e){await T(R+`/decorations/${e}`,{method:"DELETE"})},J=async function(){return fetch(R+"/decorations/presets").then(function(e){return e.json()})};function Z(e){return`${e.animated?"a_":""}${e.hash}`}const _e=i.findByProps("create","useStore"),{create:q}=_e,ee=i.findByStoreName("UserStore"),te=i.findByStoreName("SelectedChannelStore"),D=q(function(e,n){return{usersDecorations:new Map,fetchQueue:new Set,bulkFetch:t.lodash.debounce(async function(){const{fetchQueue:a,usersDecorations:r}=n();e({fetchQueue:new Set});const s=Array.from(a);if(s.length===0)return;const o=await we(s),c=new Map(r);for(const[l,v]of Object.entries(o)){c.set(l,v);const d=ee.getUser(l);d&&(d.avatarDecoration=v?{asset:v,skuId:A}:null,d.avatarDecorationData=d.avatarDecoration,t.FluxDispatcher.dispatch({type:"USER_UPDATE",user:d}))}for(const l of s)c.has(l)||c.set(l,null);e({usersDecorations:c})}),async fetch(a,r=!1){const{usersDecorations:s,fetchQueue:o,bulkFetch:c}=n();!r&&s.has(a)||(e({fetchQueue:new Set(o).add(a)}),c())},async fetchMany(a){if(!a.length)return;const{usersDecorations:r,fetchQueue:s,bulkFetch:o}=n(),c=new Set(s);for(const l of a)r.has(l)||c.add(l);e({fetchQueue:c}),o()},get(a){return n().usersDecorations.get(a)},has(a){return n().usersDecorations.has(a)},set(a,r){const{usersDecorations:s}=n(),o=new Map(s);o.set(a,r),e({usersDecorations:o})}}}),$e=[C("LOAD_MESSAGES_SUCCESS",function({messages:e}){D.getState().fetchMany(e.map(function(n){return n.author.id}))}),C("CONNECTION_OPEN",function(){D.getState().fetch(ee.getCurrentUser().id,!0)}),C("MESSAGE_CREATE",function(e){const n=te.getChannelId();e.channelId===n&&D.getState().fetch(e.message.author.id)}),C("TYPING_START",function(e){const n=te.getChannelId();e.channelId===n&&D.getState().fetch(e.userId)})];function P(e){return{asset:Z(e),skuId:A}}const Be=i.findByStoreName("UserStore");function Ue(e){const n=Be.getCurrentUser();n.avatarDecoration=e?P(e):null,n.avatarDecorationData=n.avatarDecoration,D.getState().set(n.id,e?Z(e):null),t.FluxDispatcher.dispatch({type:"CURRENT_USER_UPDATE",user:n}),t.FluxDispatcher.dispatch({type:"USER_SETTINGS_ACCOUNT_SUBMIT_SUCCESS"})}const p=q(fe.subscribeWithSelector(function(e,n){return{decorations:[],selectedDecoration:null,fetched:!1,fetch:async function(){const a=await Ie(),r=await Te();e({decorations:a,selectedDecoration:r,fetched:!0})},create:async function(a){const r=await X(a);e({decorations:[...n().decorations,r]})},delete:async function(a){const r=typeof a=="object"?a.hash:a;await Pe(r);const{selectedDecoration:s,decorations:o}=n();let c={decorations:o.filter(function(l){return l.hash!==r})};s?.hash===r&&(c.selectedDecoration=null),e(c)},select:async function(a){e({selectedDecoration:a})},clear:function(){return e({decorations:[],selectedDecoration:null,fetched:!1})}}})),ke=[p.subscribe(function(e){return[e.selectedDecoration,e.fetched]},t.lodash.debounce(function([e,n],[a,r]){n!==r||e?.hash===a?.hash||(X(e),Ue(e))},1e3)),C("CONNECTION_OPEN",function(){return p.getState().clear()})],{FormIcon:Fe}=y.Forms;function _({source:e}){return React.createElement(Fe,{source:e,style:{opacity:1}})}const{ScrollView:xe,View:ne}=t.ReactNative,{FormSection:Le,FormRow:Oe,FormArrow:me,FormInput:Me,FormDivider:ze,FormHint:$}=y.Forms,{popModal:He}=i.findByProps("pushModal"),{launchImageLibrary:Ge}=i.findByProps("launchImageLibrary"),{useSafeAreaInsets:je}=i.findByProps("useSafeAreaInsets"),Ve=i.findByProps("parseTopic"),Qe=t.stylesheet.createThemedStyleSheet({errorHint:{paddingTop:16,color:g.semanticColors.TEXT_DANGER}});function We(){const[e,n]=t.React.useState(null),[a,r]=t.React.useState(""),[s,o]=t.React.useState(!1),[c,l]=t.React.useState(null);t.React.useEffect(function(){c&&l(null)},[e]);const v=je(),d=p(function(f){return f.create});return t.React.createElement(xe,{contentContainerStyle:{flexGrow:1}},t.React.createElement(ne,{style:{flex:1}},t.React.createElement(Y,{pendingAvatarDecoration:e?{asset:e?.uri,skuId:H}:null}),c!==null&&t.React.createElement($,{style:Qe.errorHint},c.message),t.React.createElement(Le,null,t.React.createElement(Oe,{label:"Select Image",leading:t.React.createElement(_,{source:u.getAssetIDByName("ic_image")}),trailing:me,onPress:function(){Ge({mediaType:"photo"},function(f){if(!f||f.didCancel){n(null);return}const w=f.assets[0];w&&n(w)})}}),t.React.createElement($,null,"File should be APNG or PNG."),t.React.createElement(ze,null),t.React.createElement(Me,{value:a,onChange:r,placeholder:"Companion Cube",title:"Name"})),t.React.createElement($,null,Ve.parse("Make sure your decoration does not violate [the guidelines](https://github.com/decor-discord/.github/blob/main/GUIDELINES.md) before creating your decoration.",!0,{allowLinks:!0})),t.ReactNative.Platform.OS==="android"&&t.React.createElement($,null,"APNGs will not animate in the preview above on Android.")),t.React.createElement(ne,{style:{justifyContent:"flex-end",paddingHorizontal:16,paddingBottom:v.bottom}},t.React.createElement(y.Button,{text:"Create",color:"brand",size:"medium",onPress:async function(){o(!0);try{let f;t.ReactNative.Platform.OS==="ios"?f="data:"+e.type+";base64,"+await be(e.uri):f=e.uri,await d({uri:f,fileName:e.fileName,fileType:e.type,alt:a}),He("create-decoration"),I.showToast("Decoration created and pending review.",u.getAssetIDByName("Check"))}catch(f){l(f),o(!1)}},loading:s,disabled:!e||!a||e.type!=="image/png"||!!c})))}const Ke=i.findByName("Navigator")??i.findByProps("Navigator")?.Navigator,Ye=i.findByProps("getRenderCloseButton")?.getRenderCloseButton??i.findByProps("getHeaderCloseButton")?.getHeaderCloseButton,{popModal:Xe}=i.findByProps("pushModal");function Je(){return React.createElement(Ke,{initialRouteName:"CREATE_DECORATION",screens:{CREATE_DECORATION:{headerLeft:Ye(function(){return Xe("create-decoration")}),render:We,title:"Create Decoration"}}})}const{pushModal:Ze}=i.findByProps("pushModal");function qe(){return Ze({key:"create-decoration",modal:{key:"create-decoration",modal:Je,animation:"slide-up",shouldPersistUnderModals:!1,closable:!0}})}const{View:ae,TouchableOpacity:et}=t.ReactNative,{triggerHapticFeedback:tt,HapticFeedbackTypes:nt}=i.findByProps("triggerHapticFeedback"),B=t.stylesheet.createThemedStyleSheet({container:{display:"flex",justifyContent:"center",alignItems:"center",backgroundColor:g.semanticColors.BACKGROUND_FLOATING,width:72,height:72,borderRadius:4},inner:{display:"flex",justifyContent:"space-evenly",alignItems:"center"},selected:{borderWidth:2,borderColor:g.semanticColors.BUTTON_OUTLINE_BRAND_BORDER_ACTIVE},disabled:{opacity:.5}}),re=function(e,...n){tt(nt.IMPACT_LIGHT),e(...n)};function ie({onPress:e=void 0,onLongPress:n=void 0,disabled:a=void 0,lookDisabled:r=void 0,selected:s=!1,children:o}){return React.createElement(et,{onPress:e?function(...c){return re(e,...c)}:void 0,onLongPress:n?function(...c){return re(n,...c)}:void 0,disabled:a},React.createElement(ae,{style:[B.container,s?B.selected:null]},React.createElement(ae,{style:[B.inner,(a||r)&&B.disabled]},o)))}const{TextStyleSheet:at,Text:rt}=i.findByProps("TextStyleSheet");function L({source:e,label:n,onPress:a,disabled:r,lookDisabled:s=!1,selected:o=!1}){return React.createElement(ie,{onPress:a,disabled:r,lookDisabled:s,selected:o},React.createElement(_,{source:e}),React.createElement(rt,{style:[at["text-sm/medium"]]},n))}const it=i.findByProps("getAvatarDecorationURL","default"),{showSimpleActionSheet:ot}=i.findByProps("showSimpleActionSheet"),{hideActionSheet:st}=i.findByProps("openLazy","hideActionSheet"),ct=i.findByStoreName("UserStore"),{Image:lt}=t.ReactNative;function ut(e){return ot({key:"DecorationActionSheet",header:{title:e.alt??"Decoration",icon:React.createElement(lt,{source:{uri:it.getAvatarDecorationURL({avatarDecoration:P(e)})},style:{width:24,height:24,marginRight:8}}),onClose:function(){return st()}},options:[{icon:u.getAssetIDByName("ic_message_copy"),label:"Copy Decoration Hash",onPress:function(){t.clipboard.setString(e.hash),I.showToast("Copied Decoration Hash!",u.getAssetIDByName("toast_copy_message"))}},...e.authorId===ct.getCurrentUser().id?[{icon:u.getAssetIDByName("ic_message_delete"),label:"Delete",isDestructive:!0,onPress:function(){return z.showConfirmationAlert({title:"Delete Decoration",content:`Are you sure you want to delete ${e.alt??"this decoration"}?`,confirmText:"Delete",cancelText:"Cancel",confirmColor:"red",onConfirm:function(){return t.ReactNative.unstable_batchedUpdates(function(){return p.getState().delete(e)})}})}}]:[]]})}const dt=i.findByName("CutoutableAvatarDecoration");function oe({decoration:e,onPress:n=void 0,selectable:a=void 0,disabled:r=void 0}){const s=p(function(l){return l.selectedDecoration}),o=p(function(l){return l.select});a??=e.reviewed===null||e.reviewed===!0,n??=a?function(){return o(e)}:function(){return I.showToast("This decoration has not been approved yet.",u.getAssetIDByName("img_none"))};const c=s?.hash===e.hash;return React.createElement(ie,{onPress:n,onLongPress:function(){return ut(e)},selected:c,disabled:r,lookDisabled:!a},React.createElement(dt,{avatarDecoration:P(e),size:56,animate:c}))}const{FormTitle:ft}=y.Forms,{View:O,FlatList:ht,Image:Ot}=t.ReactNative,{TextStyleSheet:yt,Text:pt}=i.findByProps("TextStyleSheet");i.findByName("SummarizedIconRow",!1),i.findByProps("AvatarSizes"),t.stylesheet.createThemedStyleSheet({wrapper:{borderWidth:2,borderRadius:20,borderColor:g.semanticColors.BACKGROUND_SECONDARY,backgroundColor:g.semanticColors.BACKGROUND_SECONDARY}}),i.findByProps("getUser","fetchCurrentUser"),i.findByStoreName("UserStore"),u.getAssetIDByName("default_avatar_0"),u.getAssetIDByName("default_avatar_1"),u.getAssetIDByName("default_avatar_2"),u.getAssetIDByName("default_avatar_3"),u.getAssetIDByName("default_avatar_4"),u.getAssetIDByName("default_avatar_5");function gt({preset:e}){const n=p(function(r){return r.select}),a=t.NavigationNative.useNavigation();return React.createElement(O,null,React.createElement(O,null,React.createElement(ft,{title:e.name}),e.description&&React.createElement(pt,{style:[yt["text-sm/medium"],{paddingHorizontal:16,paddingBottom:8}]},e.description)),React.createElement(ht,{horizontal:!0,showsHorizontalScrollIndicator:!1,data:e.decorations,renderItem:function({item:r}){return React.createElement(oe,{decoration:r,onPress:function(){n(r),a.pop()}})},ItemSeparatorComponent:function(){return React.createElement(O,{style:{width:4}})},snapToInterval:74,decelerationRate:"fast",contentContainerStyle:{paddingHorizontal:8}}))}const{View:Rt}=y.General,{FlatList:St}=t.ReactNative;function Dt(){const[e,n]=t.React.useState([]);return t.React.useEffect(function(){J().then(function(a){return n(a)})},[]),t.React.createElement(St,{data:e,renderItem:function({item:a}){return t.React.createElement(gt,{preset:a})},ListFooterComponent:function(){return t.React.createElement(Rt,{style:{height:18}})}})}const{FlatList:Et,View:U,ActivityIndicator:vt,Pressable:Nt}=t.ReactNative,{FormTitle:bt}=y.Forms,{TextStyleSheet:m,Text:M}=i.findByProps("TextStyleSheet"),At=i.findByStoreName("UserStore"),Ct=i.findByProps("parse","parseToAST"),{showUserProfile:se}=i.findByProps("showUserProfile"),wt=i.findByProps("getUser","fetchCurrentUser");function It(){const[e,n]=t.React.useState(!1),[a,r]=t.React.useState([]),{decorations:s,selectedDecoration:o,fetch:c,clear:l,select:v}=p(),{isAuthorized:d}=S();t.React.useEffect(function(){d()?(J().then(function(N){return r(N)}).catch(function(){}),c().then(function(){return n(!1)}).catch(function(){return n(null)}),n(!0)):(l(),n(!1))},[d]);const f=t.NavigationNative.useNavigation(),w=s.some(function(N){return N.reviewed===!1}),de=a&&o&&a.find(function(N){return N.id===o.presetId});return t.React.createElement(t.React.Fragment,null,t.React.createElement(Y,{pendingAvatarDecoration:o?P(o):null}),o&&t.React.createElement(U,{style:{marginTop:12,paddingHorizontal:16,gap:8}},t.React.createElement(M,{style:m["text-lg/semibold"]},o.alt),de&&t.React.createElement(M,{style:m.eyebrow},"Part of the ",de.name," Preset"),t.React.createElement(M,{style:m["text-md/normal"]},"Created by"," ",t.React.createElement(Nt,{onPress:function(){return At.getUser(o.authorId)?se({userId:o.authorId}):wt.getUser(o.authorId).then(function(){return se({userId:o.authorId})})},pointerEvents:"box-only",style:{flexGrow:0,flexShrink:0}},Ct.parse(`<@${o.authorId}>`,!0)))),t.React.createElement(bt,{title:"Decorations",icon:e?t.React.createElement(vt,null):e===null?t.React.createElement(_,{source:u.getAssetIDByName("ic_warning_24px")}):void 0}),t.React.createElement(Et,{horizontal:!0,showsHorizontalScrollIndicator:!1,data:s,renderItem:function({item:N}){return t.React.createElement(oe,{decoration:N,disabled:!d()||e===null})},snapToInterval:74,decelerationRate:"fast",ItemSeparatorComponent:function(){return t.React.createElement(U,{style:{width:4}})},ListHeaderComponent:function(){return t.React.createElement(L,{source:u.getAssetIDByName("img_none"),label:"None",onPress:function(){v(null)},disabled:!d()||e===null,selected:!o})},ListHeaderComponentStyle:{paddingRight:s.length===0?2:4},ListFooterComponent:function(){return t.React.createElement(U,{style:{flexDirection:"row"}},t.React.createElement(L,{source:u.getAssetIDByName("ic_reaction_smile"),label:"Presets",onPress:function(){f.push("VendettaCustomPage",{title:"Presets",render:Dt})},selected:o&&o.presetId!==null,disabled:!d()||e===null}),t.React.createElement(U,{style:{width:4}}),t.React.createElement(L,{source:u.getAssetIDByName("ic_add_24px"),label:"New",onPress:w?function(){return I.showToast("You already have a decoration pending review!",u.getAssetIDByName("img_none"))}:qe,lookDisabled:w,disabled:!d()||e===null}))},ListFooterComponentStyle:{paddingLeft:s.length===0?2:4},contentContainerStyle:{paddingHorizontal:8}}))}const Tt=t.stylesheet.createThemedStyleSheet({versionText:{fontSize:15,color:g.semanticColors.TEXT_NORMAL,textAlign:"center",fontWeight:"600",lineHeight:22}}),{ScrollView:Pt,View:ce}=t.ReactNative,{FormSection:_t,FormRow:$t,FormArrow:Bt,FormSwitchRow:mt,FormCTAButton:le,FormDivider:Mt,FormInput:zt,useReducer:Ht}=y.Forms,Ut=y.HelpMessage;function kt(){const{isAuthorized:e}=S();return t.React.createElement(Pt,null,!e()&&t.React.createElement(ce,{style:{padding:8}},t.React.createElement(Ut,{messageType:0},"You need to Authorize with Decor before you can get custom decorations.")),t.React.createElement(It,null),!e()&&t.React.createElement(_t,null,t.React.createElement($t,{label:"Authorize with Decor",leading:t.React.createElement(_,{source:u.getAssetIDByName("ic_link_24px")}),trailing:Bt,onPress:ve})),e()&&t.React.createElement(le,{color:"danger",label:"Logout",onPress:function(){return z.showConfirmationAlert({title:"Logout",content:"Are you sure you want to logout?",confirmText:"Logout",confirmColor:"red",cancelText:"Cancel",onConfirm:function(){b.storage.token=void 0,S.getState().setToken(null)}})}}),t.React.createElement(le,{color:"brand",label:"Source",onPress:function(){return t.ReactNative.Linking.openURL("https://github.com/bwlok/revenge-plugins/tree/master/plugins/Decor")}}),t.React.createElement(t.ReactNative.Text,{style:Tt.versionText},"Decor",`
`,"Version 1.0.1"),t.React.createElement(ce,{style:{height:40}}))}const ue=i.findByStoreName("UserStore"),Ft=i.findByProps("getAvatarDecorationURL","default"),xt=i.findByProps("isAnimatedAvatarDecoration");i.findByProps("openLazy","hideActionSheet");let E=[];var Lt={onLoad:async function(){E.push(Se),E.push(...$e),E.push(...ke),E.push(F.after("getUser",ue,function(e,n){const a=D.getState();if(n&&a.has(n.id)){const r=a.get(n.id);r&&n.avatarDecoration?.skuId!==A?n.avatarDecoration={asset:r,skuId:A}:!r&&n.avatarDecoration&&n.avatarDecoration?.skuId===A&&(n.avatarDecoration=null),n.avatarDecorationData=n.avatarDecoration}})),E.push(F.instead("getAvatarDecorationURL",Ft,function(e,n){const[{avatarDecoration:a,canAnimate:r}]=e;if(a?.skuId===A){const s=a.asset.split("_");return!r&&s[0]==="a"&&s.shift(),pe+`/${s.join("_")}.png`}else return a?.skuId===H?a.asset:n(...e)})),E.push(F.after("isAnimatedAvatarDecoration",xt,function([e],n){if(t.ReactNative.Platform.OS==="ios"&&e?.asset?.startsWith("file://"))return!0})),D.getState().fetch(ue.getCurrentUser().id,!0)},onUnload:function(){E.forEach(function(e){return e()})},settings:kt};return k.default=Lt,Object.defineProperty(k,"__esModule",{value:!0}),k})({},vendetta.metro,vendetta.metro.common,vendetta.patcher,vendetta.plugin,vendetta.ui.alerts,vendetta.ui.assets,vendetta.ui,vendetta.ui.components,middleware,vendetta.ui.toasts);
