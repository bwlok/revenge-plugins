(function($,i,t,U,ce,m,u,p,h,M,C){"use strict";const le="https://decor.fieryflames.dev",g=le+"/api",ue=g+"/authorize",de="https://decorcdn.fieryflames.dev",fe="1096966363416899624",v="100101099111114",z="11497119",he=i.findByProps("create","useStore"),{create:k}=he;function N(e,n){return t.FluxDispatcher.subscribe(e,n),function(){return void t.FluxDispatcher.unsubscribe(e,n)}}const ye=t.ReactNative.NativeModules.MMKVManager,H=i.findByStoreName("UserStore"),A=k(M.persist(function(e,n){return{token:null,tokens:{},init:function(){return e({token:n().tokens[H.getCurrentUser().id]??null})},setToken:function(a){return e({token:a,tokens:{...n().tokens,[H.getCurrentUser().id]:a}})},isAuthorized:function(){return!!n().token}}},{name:"decor-auth",getStorage:function(){return ye},partialize:function(e){return{tokens:e.tokens}},onRehydrateStorage:function(){return function(e){return e.init()}}})),pe=N("CONNECTION_OPEN",function(){return A.getState().init()}),{pushModal:ge,popModal:G}=i.findByProps("pushModal"),Re=i.findByName("OAuth2AuthorizeModal");function Se(){return ge({key:"oauth2-authorize",modal:{key:"oauth2-authorize",modal:Re,animation:"slide-up",shouldPersistUnderModals:!1,props:{clientId:fe,redirectUri:ue,scopes:["identify"],responseType:"code",permissions:0n,cancelCompletesFlow:!1,callback:async function({location:e}){const n=new URL(e);n.searchParams.append("client","vendetta");const a=await fetch(n);if(a?.ok){const r=await a.text();A.getState().setToken(r)}else G("oauth2-authorize")},dismissOAuthModal:function(){return G("oauth2-authorize")}},closable:!0}})}const De=t.ReactNative.NativeModules.DCDFileManager??t.ReactNative.NativeModules.RTNFileManager;async function Ee(e){return e.startsWith("file://")&&(e=e.slice(7)),De.readFile(e,"base64")}const{View:j}=h.General,ve=i.findByName("HeaderAvatar"),Ne=i.findByStoreName("UserStore"),V=t.stylesheet.createThemedStyleSheet({headerAvatarContainer:{display:"flex",justifyContent:"center",alignItems:"center",backgroundColor:p.semanticColors.BACKGROUND_FLOATING,width:208,height:208,borderRadius:4},container:{flexDirection:"row",width:"100%",justifyContent:"center",alignItems:"center",paddingHorizontal:16,paddingTop:16}});function K({pendingAvatarDecoration:e}){return React.createElement(j,{style:V.container},React.createElement(j,{style:V.headerAvatarContainer},React.createElement(ve,{user:Ne.getCurrentUser(),pendingAvatarDecoration:e,size:"editAvatarDecoration",decorationStyle:{margin:-12}})))}async function I(e,n){const a=await fetch(e,{...n,headers:{...n?.headers,Authorization:`Bearer ${A.getState().token}`}});if(a.ok)return a;throw new Error(await a.text())}const Ae=async function(e=void 0){if(e&&e.length===0)return{};const n=new URL(g+"/users");return e&&e.length!==0&&n.searchParams.set("ids",JSON.stringify(e)),await fetch(n).then(function(a){return a.json()})},be=async function(e="@me"){return I(g+`/users/${e}/decorations`).then(function(n){return n.json()})},Ce=async function(e="@me"){return I(g+`/users/${e}/decoration`).then(function(n){return n.json()})},Q=async function(e,n="@me"){const a=new FormData;return e&&Object.hasOwn(e,"hash")?(e=e,a.append("hash",e.hash)):e?e&&Object.hasOwn(e,"uri")&&(e=e,a.append("image",{uri:e.uri,type:e.fileType,name:e.fileName}),a.append("alt",e.alt)):a.append("hash",null),I(g+`/users/${n}/decoration`,{method:"PUT",body:a}).then(function(r){return e&&Object.hasOwn(e,"uri")?r.json():r.text()})},Ie=async function(e){await I(g+`/decorations/${e}`,{method:"DELETE"})},W=async function(){return fetch(g+"/decorations/presets").then(function(e){return e.json()})};function Y(e){return`${e.animated?"a_":""}${e.hash}`}const X=i.findByStoreName("UserStore"),J=i.findByStoreName("SelectedChannelStore"),R=k(function(e,n){return{usersDecorations:new Map,fetchQueue:new Set,bulkFetch:t.lodash.debounce(async function(){const{fetchQueue:a,usersDecorations:r}=n();e({fetchQueue:new Set});const s=Array.from(a);if(s.length===0)return;const o=await Ae(s),c=new Map(r);for(const[l,D]of Object.entries(o)){c.set(l,D);const d=X.getUser(l);d&&(d.avatarDecoration=D?{asset:D,skuId:v}:null,d.avatarDecorationData=d.avatarDecoration,t.FluxDispatcher.dispatch({type:"USER_UPDATE",user:d}))}for(const l of s)c.has(l)||c.set(l,null);e({usersDecorations:c})}),async fetch(a,r=!1){const{usersDecorations:s,fetchQueue:o,bulkFetch:c}=n();!r&&s.has(a)||(e({fetchQueue:new Set(o).add(a)}),c())},async fetchMany(a){if(!a.length)return;const{usersDecorations:r,fetchQueue:s,bulkFetch:o}=n(),c=new Set(s);for(const l of a)r.has(l)||c.add(l);e({fetchQueue:c}),o()},get(a){return n().usersDecorations.get(a)},has(a){return n().usersDecorations.has(a)},set(a,r){const{usersDecorations:s}=n(),o=new Map(s);o.set(a,r),e({usersDecorations:o})}}}),we=[N("LOAD_MESSAGES_SUCCESS",function({messages:e}){R.getState().fetchMany(e.map(function(n){return n.author.id}))}),N("CONNECTION_OPEN",function(){R.getState().fetch(X.getCurrentUser().id,!0)}),N("MESSAGE_CREATE",function(e){const n=J.getChannelId();e.channelId===n&&R.getState().fetch(e.message.author.id)}),N("TYPING_START",function(e){const n=J.getChannelId();e.channelId===n&&R.getState().fetch(e.userId)})];function w(e){return{asset:Y(e),skuId:v}}const Te=i.findByStoreName("UserStore");function Pe(e){const n=Te.getCurrentUser();n.avatarDecoration=e?w(e):null,n.avatarDecorationData=n.avatarDecoration,R.getState().set(n.id,e?Y(e):null),t.FluxDispatcher.dispatch({type:"CURRENT_USER_UPDATE",user:n}),t.FluxDispatcher.dispatch({type:"USER_SETTINGS_ACCOUNT_SUBMIT_SUCCESS"})}const y=k(M.subscribeWithSelector(function(e,n){return{decorations:[],selectedDecoration:null,fetched:!1,fetch:async function(){const a=await be(),r=await Ce();e({decorations:a,selectedDecoration:r,fetched:!0})},create:async function(a){const r=await Q(a);e({decorations:[...n().decorations,r]})},delete:async function(a){const r=typeof a=="object"?a.hash:a;await Ie(r);const{selectedDecoration:s,decorations:o}=n();let c={decorations:o.filter(function(l){return l.hash!==r})};s?.hash===r&&(c.selectedDecoration=null),e(c)},select:async function(a){e({selectedDecoration:a})},clear:function(){return e({decorations:[],selectedDecoration:null,fetched:!1})}}})),Be=[y.subscribe(function(e){return[e.selectedDecoration,e.fetched]},t.lodash.debounce(function([e,n],[a,r]){n!==r||e?.hash===a?.hash||(Q(e),Pe(e))},1e3)),N("CONNECTION_OPEN",function(){return y.getState().clear()})],{FormIcon:_e}=h.Forms;function T({source:e}){return React.createElement(_e,{source:e,style:{opacity:1}})}const{ScrollView:$e,View:Z}=t.ReactNative,{FormSection:Ue,FormRow:ke,FormArrow:Fe,FormInput:xe,FormDivider:Le,FormHint:P}=h.Forms,{popModal:Oe}=i.findByProps("pushModal"),{launchImageLibrary:me}=i.findByProps("launchImageLibrary"),{useSafeAreaInsets:Me}=i.findByProps("useSafeAreaInsets"),ze=i.findByProps("parseTopic"),He=t.stylesheet.createThemedStyleSheet({errorHint:{paddingTop:16,color:p.semanticColors.TEXT_DANGER}});function Ge(){const[e,n]=t.React.useState(null),[a,r]=t.React.useState(""),[s,o]=t.React.useState(!1),[c,l]=t.React.useState(null);t.React.useEffect(function(){c&&l(null)},[e]);const D=Me(),d=y(function(f){return f.create});return t.React.createElement($e,{contentContainerStyle:{flexGrow:1}},t.React.createElement(Z,{style:{flex:1}},t.React.createElement(K,{pendingAvatarDecoration:e?{asset:e?.uri,skuId:z}:null}),c!==null&&t.React.createElement(P,{style:He.errorHint},c.message),t.React.createElement(Ue,null,t.React.createElement(ke,{label:"Select Image",leading:t.React.createElement(T,{source:u.getAssetIDByName("ic_image")}),trailing:Fe,onPress:function(){me({mediaType:"photo"},function(f){if(!f||f.didCancel){n(null);return}const b=f.assets[0];b&&n(b)})}}),t.React.createElement(P,null,"File should be APNG or PNG."),t.React.createElement(Le,null),t.React.createElement(xe,{value:a,onChange:r,placeholder:"Companion Cube",title:"Name"})),t.React.createElement(P,null,ze.parse("Make sure your decoration does not violate [the guidelines](https://github.com/decor-discord/.github/blob/main/GUIDELINES.md) before creating your decoration.",!0,{allowLinks:!0})),t.ReactNative.Platform.OS==="android"&&t.React.createElement(P,null,"APNGs will not animate in the preview above on Android.")),t.React.createElement(Z,{style:{justifyContent:"flex-end",paddingHorizontal:16,paddingBottom:D.bottom}},t.React.createElement(h.Button,{text:"Create",color:"brand",size:"medium",onPress:async function(){o(!0);try{let f;t.ReactNative.Platform.OS==="ios"?f="data:"+e.type+";base64,"+await Ee(e.uri):f=e.uri,await d({uri:f,fileName:e.fileName,fileType:e.type,alt:a}),Oe("create-decoration"),C.showToast("Decoration created and pending review.",u.getAssetIDByName("Check"))}catch(f){l(f),o(!1)}},loading:s,disabled:!e||!a||e.type!=="image/png"||!!c})))}const je=i.findByName("Navigator")??i.findByProps("Navigator")?.Navigator,Ve=i.findByProps("getRenderCloseButton")?.getRenderCloseButton??i.findByProps("getHeaderCloseButton")?.getHeaderCloseButton,{popModal:Ke}=i.findByProps("pushModal");function Qe(){return React.createElement(je,{initialRouteName:"CREATE_DECORATION",screens:{CREATE_DECORATION:{headerLeft:Ve(function(){return Ke("create-decoration")}),render:Ge,title:"Create Decoration"}}})}const{pushModal:We}=i.findByProps("pushModal");function Ye(){return We({key:"create-decoration",modal:{key:"create-decoration",modal:Qe,animation:"slide-up",shouldPersistUnderModals:!1,closable:!0}})}const{View:q,TouchableOpacity:Xe}=t.ReactNative,{triggerHapticFeedback:Je,HapticFeedbackTypes:Ze}=i.findByProps("triggerHapticFeedback"),B=t.stylesheet.createThemedStyleSheet({container:{display:"flex",justifyContent:"center",alignItems:"center",backgroundColor:p.semanticColors.BACKGROUND_FLOATING,width:72,height:72,borderRadius:4},inner:{display:"flex",justifyContent:"space-evenly",alignItems:"center"},selected:{borderWidth:2,borderColor:p.semanticColors.BUTTON_OUTLINE_BRAND_BORDER_ACTIVE},disabled:{opacity:.5}}),ee=function(e,...n){Je(Ze.IMPACT_LIGHT),e(...n)};function te({onPress:e=void 0,onLongPress:n=void 0,disabled:a=void 0,lookDisabled:r=void 0,selected:s=!1,children:o}){return React.createElement(Xe,{onPress:e?function(...c){return ee(e,...c)}:void 0,onLongPress:n?function(...c){return ee(n,...c)}:void 0,disabled:a},React.createElement(q,{style:[B.container,s?B.selected:null]},React.createElement(q,{style:[B.inner,(a||r)&&B.disabled]},o)))}const{TextStyleSheet:qe,Text:et}=i.findByProps("TextStyleSheet");function F({source:e,label:n,onPress:a,disabled:r,lookDisabled:s=!1,selected:o=!1}){return React.createElement(te,{onPress:a,disabled:r,lookDisabled:s,selected:o},React.createElement(T,{source:e}),React.createElement(et,{style:[qe["text-sm/medium"]]},n))}const tt=i.findByProps("getAvatarDecorationURL","default"),{showSimpleActionSheet:nt}=i.findByProps("showSimpleActionSheet"),{hideActionSheet:at}=i.findByProps("openLazy","hideActionSheet"),rt=i.findByStoreName("UserStore"),{Image:it}=t.ReactNative;function ot(e){return nt({key:"DecorationActionSheet",header:{title:e.alt??"Decoration",icon:React.createElement(it,{source:{uri:tt.getAvatarDecorationURL({avatarDecoration:w(e)})},style:{width:24,height:24,marginRight:8}}),onClose:function(){return at()}},options:[{icon:u.getAssetIDByName("ic_message_copy"),label:"Copy Decoration Hash",onPress:function(){t.clipboard.setString(e.hash),C.showToast("Copied Decoration Hash!",u.getAssetIDByName("toast_copy_message"))}},...e.authorId===rt.getCurrentUser().id?[{icon:u.getAssetIDByName("ic_message_delete"),label:"Delete",isDestructive:!0,onPress:function(){return m.showConfirmationAlert({title:"Delete Decoration",content:`Are you sure you want to delete ${e.alt??"this decoration"}?`,confirmText:"Delete",cancelText:"Cancel",confirmColor:"red",onConfirm:function(){return t.ReactNative.unstable_batchedUpdates(function(){return y.getState().delete(e)})}})}}]:[]]})}const st=i.findByName("CutoutableAvatarDecoration");function ne({decoration:e,onPress:n=void 0,selectable:a=void 0,disabled:r=void 0}){const s=y(function(l){return l.selectedDecoration}),o=y(function(l){return l.select});a??=e.reviewed===null||e.reviewed===!0,n??=a?function(){return o(e)}:function(){return C.showToast("This decoration has not been approved yet.",u.getAssetIDByName("img_none"))};const c=s?.hash===e.hash;return React.createElement(te,{onPress:n,onLongPress:function(){return ot(e)},selected:c,disabled:r,lookDisabled:!a},React.createElement(st,{avatarDecoration:w(e),size:56,animate:c}))}const{FormTitle:ct}=h.Forms,{View:x,FlatList:lt,Image:kt}=t.ReactNative,{TextStyleSheet:ut,Text:dt}=i.findByProps("TextStyleSheet");i.findByName("SummarizedIconRow",!1),i.findByProps("AvatarSizes"),t.stylesheet.createThemedStyleSheet({wrapper:{borderWidth:2,borderRadius:20,borderColor:p.semanticColors.BACKGROUND_SECONDARY,backgroundColor:p.semanticColors.BACKGROUND_SECONDARY}}),i.findByProps("getUser","fetchCurrentUser"),i.findByStoreName("UserStore"),u.getAssetIDByName("default_avatar_0"),u.getAssetIDByName("default_avatar_1"),u.getAssetIDByName("default_avatar_2"),u.getAssetIDByName("default_avatar_3"),u.getAssetIDByName("default_avatar_4"),u.getAssetIDByName("default_avatar_5");function ft({preset:e}){const n=y(function(r){return r.select}),a=t.NavigationNative.useNavigation();return React.createElement(x,null,React.createElement(x,null,React.createElement(ct,{title:e.name}),e.description&&React.createElement(dt,{style:[ut["text-sm/medium"],{paddingHorizontal:16,paddingBottom:8}]},e.description)),React.createElement(lt,{horizontal:!0,showsHorizontalScrollIndicator:!1,data:e.decorations,renderItem:function({item:r}){return React.createElement(ne,{decoration:r,onPress:function(){n(r),a.pop()}})},ItemSeparatorComponent:function(){return React.createElement(x,{style:{width:4}})},snapToInterval:74,decelerationRate:"fast",contentContainerStyle:{paddingHorizontal:8}}))}const{View:ht}=h.General,{FlatList:yt}=t.ReactNative;function pt(){const[e,n]=t.React.useState([]);return t.React.useEffect(function(){W().then(function(a){return n(a)})},[]),t.React.createElement(yt,{data:e,renderItem:function({item:a}){return t.React.createElement(ft,{preset:a})},ListFooterComponent:function(){return t.React.createElement(ht,{style:{height:18}})}})}const{FlatList:gt,View:_,ActivityIndicator:Rt,Pressable:St}=t.ReactNative,{FormTitle:Dt}=h.Forms,{TextStyleSheet:L,Text:O}=i.findByProps("TextStyleSheet"),Et=i.findByStoreName("UserStore"),vt=i.findByProps("parse","parseToAST"),{showUserProfile:ae}=i.findByProps("showUserProfile"),Nt=i.findByProps("getUser","fetchCurrentUser");function At(){const[e,n]=t.React.useState(!1),[a,r]=t.React.useState([]),{decorations:s,selectedDecoration:o,fetch:c,clear:l,select:D}=y(),{isAuthorized:d}=A();t.React.useEffect(function(){d()?(W().then(function(E){return r(E)}).catch(function(){}),c().then(function(){return n(!1)}).catch(function(){return n(null)}),n(!0)):(l(),n(!1))},[d]);const f=t.NavigationNative.useNavigation(),b=s.some(function(E){return E.reviewed===!1}),se=a&&o&&a.find(function(E){return E.id===o.presetId});return t.React.createElement(t.React.Fragment,null,t.React.createElement(K,{pendingAvatarDecoration:o?w(o):null}),o&&t.React.createElement(_,{style:{marginTop:12,paddingHorizontal:16,gap:8}},t.React.createElement(O,{style:L["text-lg/semibold"]},o.alt),se&&t.React.createElement(O,{style:L.eyebrow},"Part of the ",se.name," Preset"),t.React.createElement(O,{style:L["text-md/normal"]},"Created by"," ",t.React.createElement(St,{onPress:function(){return Et.getUser(o.authorId)?ae({userId:o.authorId}):Nt.getUser(o.authorId).then(function(){return ae({userId:o.authorId})})},pointerEvents:"box-only",style:{flexGrow:0,flexShrink:0}},vt.parse(`<@${o.authorId}>`,!0)))),t.React.createElement(Dt,{title:"Decorations",icon:e?t.React.createElement(Rt,null):e===null?t.React.createElement(T,{source:u.getAssetIDByName("ic_warning_24px")}):void 0}),t.React.createElement(gt,{horizontal:!0,showsHorizontalScrollIndicator:!1,data:s,renderItem:function({item:E}){return t.React.createElement(ne,{decoration:E,disabled:!d()||e===null})},snapToInterval:74,decelerationRate:"fast",ItemSeparatorComponent:function(){return t.React.createElement(_,{style:{width:4}})},ListHeaderComponent:function(){return t.React.createElement(F,{source:u.getAssetIDByName("img_none"),label:"None",onPress:function(){D(null)},disabled:!d()||e===null,selected:!o})},ListHeaderComponentStyle:{paddingRight:s.length===0?2:4},ListFooterComponent:function(){return t.React.createElement(_,{style:{flexDirection:"row"}},t.React.createElement(F,{source:u.getAssetIDByName("ic_reaction_smile"),label:"Presets",onPress:function(){f.push("VendettaCustomPage",{title:"Presets",render:pt})},selected:o&&o.presetId!==null,disabled:!d()||e===null}),t.React.createElement(_,{style:{width:4}}),t.React.createElement(F,{source:u.getAssetIDByName("ic_add_24px"),label:"New",onPress:b?function(){return C.showToast("You already have a decoration pending review!",u.getAssetIDByName("img_none"))}:Ye,lookDisabled:b,disabled:!d()||e===null}))},ListFooterComponentStyle:{paddingLeft:s.length===0?2:4},contentContainerStyle:{paddingHorizontal:8}}))}const bt=t.stylesheet.createThemedStyleSheet({versionText:{fontSize:15,color:p.semanticColors.TEXT_NORMAL,textAlign:"center",fontWeight:"600",lineHeight:22}}),{ScrollView:Ct,View:re}=t.ReactNative,{FormSection:It,FormRow:wt,FormArrow:Tt,FormSwitchRow:Ft,FormCTAButton:ie,FormDivider:xt,FormInput:Lt,useReducer:Ot}=h.Forms,Pt=h.HelpMessage;function Bt(){const{isAuthorized:e}=A();return t.React.createElement(Ct,null,!e()&&t.React.createElement(re,{style:{padding:8}},t.React.createElement(Pt,{messageType:0},"You need to Authorize with Decor before you can get custom decorations.")),t.React.createElement(At,null),!e()&&t.React.createElement(It,null,t.React.createElement(wt,{label:"Authorize with Decor",leading:t.React.createElement(T,{source:u.getAssetIDByName("ic_link_24px")}),trailing:Tt,onPress:Se})),e()&&t.React.createElement(ie,{color:"danger",label:"Logout",onPress:function(){return m.showConfirmationAlert({title:"Logout",content:"Are you sure you want to logout?",confirmText:"Logout",confirmColor:"red",cancelText:"Cancel",onConfirm:function(){ce.storage.token=void 0,A.getState().setToken(null)}})}}),t.React.createElement(ie,{color:"brand",label:"Source",onPress:function(){return t.ReactNative.Linking.openURL("https://github.com/bwlok/revenge-plugins/tree/master/plugins/Decor")}}),t.React.createElement(t.ReactNative.Text,{style:bt.versionText},"Decor",`
`,"Version 1.0.0"),t.React.createElement(re,{style:{height:40}}))}const oe=i.findByStoreName("UserStore"),_t=i.findByProps("getAvatarDecorationURL","default"),$t=i.findByProps("isAnimatedAvatarDecoration");i.findByProps("openLazy","hideActionSheet");let S=[];var Ut={onLoad:async function(){S.push(pe),S.push(...we),S.push(...Be),S.push(U.after("getUser",oe,function(e,n){const a=R.getState();if(n&&a.has(n.id)){const r=a.get(n.id);r&&n.avatarDecoration?.skuId!==v?n.avatarDecoration={asset:r,skuId:v}:!r&&n.avatarDecoration&&n.avatarDecoration?.skuId===v&&(n.avatarDecoration=null),n.avatarDecorationData=n.avatarDecoration}})),S.push(U.instead("getAvatarDecorationURL",_t,function(e,n){const[{avatarDecoration:a,canAnimate:r}]=e;if(a?.skuId===v){const s=a.asset.split("_");return!r&&s[0]==="a"&&s.shift(),de+`/${s.join("_")}.png`}else return a?.skuId===z?a.asset:n(...e)})),S.push(U.after("isAnimatedAvatarDecoration",$t,function([e],n){if(t.ReactNative.Platform.OS==="ios"&&e?.asset?.startsWith("file://"))return!0})),R.getState().fetch(oe.getCurrentUser().id,!0)},onUnload:function(){S.forEach(function(e){return e()})},settings:Bt};return $.default=Ut,Object.defineProperty($,"__esModule",{value:!0}),$})({},vendetta.metro,vendetta.metro.common,vendetta.patcher,vendetta.plugin,vendetta.ui.alerts,vendetta.ui.assets,vendetta.ui,vendetta.ui.components,middleware,vendetta.ui.toasts);
